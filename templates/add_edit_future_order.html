<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - {{ session.get('business_name', 'Business Dashboard') }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #10B981; /* Emerald 500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #059669; /* Emerald 600 */
        }
        .btn-secondary {
            background-color: #6B7280; /* Gray 500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4B5563; /* Gray 600 */
        }
        .flash-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .flash-success {
            background-color: #D1FAE5; /* Green 100 */
            color: #065F46; /* Green 800 */
            border: 1px solid #34D399; /* Green 400 */
        }
        .flash-danger {
            background-color: #FEE2E2; /* Red 100 */
            color: #991B1B; /* Red 800 */
            border: 1px solid #F87171; /* Red 400 */
        }
        .flash-warning {
            background-color: #FFFBEB; /* Yellow 100 */
            color: #92400E; /* Yellow 800 */
            border: 1px solid #FCD34D; /* Yellow 400 */
        }
        .flash-info {
            background-color: #DBEAFE; /* Blue 100 */
            color: #1E40AF; /* Blue 800 */
            border: 1px solid #60A5FA; /* Blue 400 */
        }
        .flash-message i {
            margin-right: 0.75rem;
        }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }
        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        tr:hover {
            background-color: #f0f4f8;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .action-buttons .btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container py-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'danger' %}fa-times-circle{% elif category == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">{{ title }}</h1>
            <a href="{{ url_for('future_orders') }}" class="btn btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Future Orders
            </a>
        </div>

        <div class="card">
            <form id="futureOrderForm" method="POST">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="customer_name" class="block text-gray-700 text-sm font-semibold mb-2">Customer Name:</label>
                        <input type="text" id="customer_name" name="customer_name" value="{{ order.customer_name if order else '' }}"
                               class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div>
                        <label for="customer_phone" class="block text-gray-700 text-sm font-semibold mb-2">Customer Phone (Optional):</label>
                        <input type="tel" id="customer_phone" name="customer_phone" value="{{ order.customer_phone if order else '' }}"
                               class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="expected_collection_date" class="block text-gray-700 text-sm font-semibold mb-2">Expected Collection Date:</label>
                        <input type="date" id="expected_collection_date" name="expected_collection_date" value="{{ order.expected_collection_date if order else '' }}"
                               class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    {% if order.id %} {# Only show status for existing orders #}
                    <div>
                        <label for="status" class="block text-gray-700 text-sm font-semibold mb-2">Status:</label>
                        <select id="status" name="status"
                                class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="Pending" {% if order.status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Collected" {% if order.status == 'Collected' %}selected{% endif %}>Collected</option>
                            <option value="Cancelled" {% if order.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>
                    {% endif %}
                </div>

                <h2 class="text-xl font-semibold mb-3 text-gray-700">Order Items</h2>
                <div class="mb-4">
                    <label for="product_select" class="block text-gray-700 text-sm font-semibold mb-2">Select Item:</label>
                    <div class="flex space-x-2">
                        <select id="product_select"
                                class="flex-grow shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">-- Select an item --</option>
                            {% for item in inventory_items %}
                                <option value="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}"
                                        data-sale-price="{{ '%.2f'|format(item.sale_price) }}"
                                        data-unit-price="{{ '%.2f'|format(item.unit_price_per_tab) }}"
                                        data-number-of-tabs="{{ item.number_of_tabs }}"
                                        data-current-stock="{{ item.current_stock }}">
                                    {{ item.product_name }} (Stock: {{ '%.2f'|format(item.current_stock) }})
                                </option>
                            {% endfor %}
                        </select>
                        <button type="button" id="add_item_to_cart" class="btn bg-blue-500 hover:bg-blue-600 text-white flex items-center">
                            <i class="fas fa-plus mr-2"></i> Add Item
                        </button>
                    </div>
                </div>

                <div class="table-container mb-6">
                    <table id="cart_table">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b">Item Name</th>
                                <th class="py-2 px-4 border-b">Quantity</th>
                                <th class="py-2 px-4 border-b">Unit Type</th>
                                <th class="py-2 px-4 border-b">Price/Unit (GH₵)</th>
                                <th class="py-2 px-4 border-b">Total (GH₵)</th>
                                <th class="py-2 px-4 border-b">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Cart items will be added here by JavaScript #}
                            {% if order.items %}
                                {% for item in order.items %}
                                <tr data-product-id="{{ item.product_id }}">
                                    <td class="py-2 px-4 border-b">{{ item.product_name }}</td>
                                    <td class="py-2 px-4 border-b">
                                        <input type="number" value="{{ '%.2f'|format(item.quantity) }}" min="0.01" step="0.01"
                                               class="quantity-input w-24 border rounded px-2 py-1"
                                               data-unit-price="{{ item.unit_price }}">
                                    </td>
                                    <td class="py-2 px-4 border-b">
                                        <select class="unit-type-select border rounded px-2 py-1"
                                                data-sale-price="{{ item.unit_price * item.quantity }}" {# This is not correct, should be original pack price #}
                                                data-unit-price="{{ item.unit_price }}"
                                                data-number-of-tabs="{{ item.number_of_tabs if item.number_of_tabs else 1 }}">
                                            <option value="pack" {% if item.unit_type == 'pack' %}selected{% endif %}>Pack</option>
                                            <option value="tab" {% if item.unit_type == 'tab' %}selected{% endif %}>Unit/Piece</option>
                                        </select>
                                    </td>
                                    <td class="py-2 px-4 border-b item-price">{{ "%.2f"|format(item.unit_price) }}</td>
                                    <td class="py-2 px-4 border-b item-total">{{ "%.2f"|format(item.quantity * item.unit_price) }}</td>
                                    <td class="py-2 px-4 border-b">
                                        <button type="button" class="remove-item-btn bg-red-500 hover:bg-red-600 text-white btn">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="py-2 px-4 border-b font-bold text-right">Grand Total:</td>
                                <td class="py-2 px-4 border-b font-bold" id="grand_total">{{ "%.2f"|format(order.total_amount) if order else "0.00" }}</td>
                                <td class="py-2 px-4 border-b"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <input type="hidden" name="cart_items_json" id="cart_items_json">

                <div class="flex items-center justify-between">
                    <button type="submit" class="btn btn-primary flex items-center">
                        <i class="fas fa-save mr-2"></i> Save Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const productSelect = document.getElementById('product_select');
            const addItemButton = document.getElementById('add_item_to_cart');
            const cartTableBody = document.querySelector('#cart_table tbody');
            const grandTotalElement = document.getElementById('grand_total');
            const cartItemsJsonInput = document.getElementById('cart_items_json');
            const futureOrderForm = document.getElementById('futureOrderForm');

            let cart = [];

            // Populate cart from existing order items on page load (for edit mode)
            {% if order.items %}
                cart = {{ order.items | tojson }};
                // Adjust for the 'number_of_tabs' which might not be in old order.items
                cart.forEach(item => {
                    const selectedOption = productSelect.querySelector(`option[value="${item.product_id}"]`);
                    if (selectedOption) {
                        item.number_of_tabs = parseFloat(selectedOption.dataset.numberOfTabs || 1);
                        item.sale_price_pack = parseFloat(selectedOption.dataset.salePrice); // Store original pack price
                    } else {
                        // Fallback if product not found (e.g., deleted from inventory)
                        item.number_of_tabs = 1;
                        item.sale_price_pack = item.unit_price * item.quantity; // Estimate if not available
                    }
                    // Ensure unit_price is correctly set based on unit_type for existing items
                    if (item.unit_type === 'pack') {
                        item.price_at_time_per_unit_sold = item.sale_price_pack;
                    } else {
                        item.price_at_time_per_unit_sold = item.unit_price;
                    }
                });
                updateCartDisplay();
            {% endif %}

            addItemButton.addEventListener('click', function() {
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                if (!selectedOption.value) {
                    alert('Please select an item to add.');
                    return;
                }

                const productId = selectedOption.value;
                const productName = selectedOption.dataset.productName;
                const salePricePack = parseFloat(selectedOption.dataset.salePrice); // Sale price for the whole pack/item
                const unitPricePerTab = parseFloat(selectedOption.dataset.unitPrice); // Sale price per tab/piece
                const numberOfTabs = parseFloat(selectedOption.dataset.numberOfTabs);
                const currentStock = parseFloat(selectedOption.dataset.currentStock);

                // Check if item is already in cart, if so, increment quantity
                const existingItemInCart = cart.find(item => item.product_id === productId);

                if (existingItemInCart) {
                    // For future orders, we don't automatically increment quantity to avoid over-ordering
                    // User should manually adjust quantities in the cart table.
                    alert(`"${productName}" is already in the order. Please adjust quantity directly in the table.`);
                } else {
                    // Add new item to cart with default quantity 1, defaulting to 'pack' unit
                    cart.push({
                        product_id: productId,
                        product_name: productName,
                        quantity: 1, // Default quantity for new item
                        sale_unit_type: 'pack', // Default unit type
                        price_at_time_per_unit_sold: salePricePack, // Default to pack price
                        item_total_amount: salePricePack,
                        number_of_tabs: numberOfTabs, // Store for unit price calculation
                        sale_price_pack: salePricePack, // Store original pack price
                        unit_price_per_tab: unitPricePerTab, // Store original unit price
                        current_stock: currentStock // For validation
                    });
                }
                updateCartDisplay();
                productSelect.value = ""; // Clear selection
            });

            function updateCartDisplay() {
                cartTableBody.innerHTML = '';
                let grandTotal = 0;

                cart.forEach((item, index) => {
                    const row = cartTableBody.insertRow();
                    row.dataset.productId = item.product_id;

                    // Item Name
                    row.insertCell().textContent = item.product_name;

                    // Quantity Input
                    const quantityCell = row.insertCell();
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.value = item.quantity;
                    quantityInput.min = "0.01";
                    quantityInput.step = "0.01";
                    quantityInput.classList.add('quantity-input', 'w-24', 'border', 'rounded', 'px-2', 'py-1');
                    quantityInput.addEventListener('change', function() {
                        const newQuantity = parseFloat(this.value);
                        if (isNaN(newQuantity) || newQuantity <= 0) {
                            alert('Quantity must be a positive number.');
                            this.value = item.quantity; // Revert to old value
                            return;
                        }
                        // For future orders, we don't validate against current_stock here,
                        // as stock is deducted at order creation. Validation happens in Flask route.
                        item.quantity = newQuantity;
                        updateItemTotal(row, item);
                        updateGrandTotal();
                    });
                    quantityCell.appendChild(quantityInput);

                    // Unit Type Select
                    const unitTypeCell = row.insertCell();
                    const unitTypeSelect = document.createElement('select');
                    unitTypeSelect.classList.add('unit-type-select', 'border', 'rounded', 'px-2', 'py-1');
                    unitTypeSelect.innerHTML = `
                        <option value="pack" ${item.sale_unit_type === 'pack' ? 'selected' : ''}>Pack</option>
                        <option value="tab" ${item.sale_unit_type === 'tab' ? 'selected' : ''}>Unit/Piece</option>
                    `;
                    unitTypeSelect.addEventListener('change', function() {
                        item.sale_unit_type = this.value;
                        updateItemPriceAndTotal(row, item);
                        updateGrandTotal();
                    });
                    unitTypeCell.appendChild(unitTypeSelect);

                    // Price/Unit
                    const priceCell = row.insertCell();
                    priceCell.classList.add('item-price');
                    priceCell.textContent = parseFloat(item.price_at_time_per_unit_sold).toFixed(2);

                    // Total
                    const totalCell = row.insertCell();
                    totalCell.classList.add('item-total');
                    totalCell.textContent = parseFloat(item.item_total_amount).toFixed(2);

                    // Actions
                    const actionsCell = row.insertCell();
                    const removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.classList.add('remove-item-btn', 'bg-red-500', 'hover:bg-red-600', 'text-white', 'btn');
                    removeButton.innerHTML = '<i class="fas fa-times"></i> Remove';
                    removeButton.addEventListener('click', function() {
                        cart.splice(index, 1);
                        updateCartDisplay();
                    });
                    actionsCell.appendChild(removeButton);

                    grandTotal += item.item_total_amount;
                });

                grandTotalElement.textContent = grandTotal.toFixed(2);
                cartItemsJsonInput.value = JSON.stringify(cart);
            }

            function updateItemPriceAndTotal(row, item) {
                let pricePerUnit;
                if (item.sale_unit_type === 'pack') {
                    pricePerUnit = item.sale_price_pack;
                } else {
                    pricePerUnit = item.unit_price_per_tab;
                }
                item.price_at_time_per_unit_sold = pricePerUnit;
                item.item_total_amount = item.quantity * pricePerUnit;

                row.querySelector('.item-price').textContent = pricePerUnit.toFixed(2);
                row.querySelector('.item-total').textContent = item.item_total_amount.toFixed(2);
            }

            function updateItemTotal(row, item) {
                item.item_total_amount = item.quantity * item.price_at_time_per_unit_sold;
                row.querySelector('.item-total').textContent = item.item_total_amount.toFixed(2);
            }

            function updateGrandTotal() {
                let grandTotal = 0;
                cart.forEach(item => {
                    grandTotal += item.item_total_amount;
                });
                grandTotalElement.textContent = grandTotal.toFixed(2);
                cartItemsJsonInput.value = JSON.stringify(cart);
            }
        });
    </script>
</body>
</html>
