{% extends 'base.html' %}

{% block content %}
<div class="container py-4 bg-white rounded shadow">
    <h2 class="h3 font-weight-bold text-dark mb-4">Dashboard</h2>

    <div class="alert alert-info border-left border-info p-3 mb-4 rounded" role="alert">
        <p class="font-weight-bold">Welcome, {{ username }}!</p>
        <p>You are logged in as a <span class="font-weight-semibold">{{ user_role.replace('_', ' ').title() }}</span> for the business: <span class="font-weight-semibold">{{ business_name }} ({{ business_type }})</span>.</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }} rounded p-3 mb-3 shadow-sm">
                        {% if category == 'success' %}<i class="fas fa-check-circle"></i>
                        {% elif category == 'danger' %}<i class="fas fa-times-circle"></i>
                        {% elif category == 'warning' %}<i class="fas fa-exclamation-triangle"></i>
                        {% elif category == 'info' %}<i class="fas fa-info-circle"></i>
                        {% endif %}
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="row mb-4">
        {# Quick Actions Card #}
        <div class="col-lg-6 mb-4">
            <div class="card p-3">
                <h3 class="h5 font-weight-semibold text-dark mb-3">Quick Actions</h3>
                <div class="row no-gutters">
                    {% if user_role in ['admin', 'sales'] %}
                    <div class="col-sm-6 p-2">
                        <a href="{{ url_for('add_sale') }}" class="btn btn-primary d-flex align-items-center justify-content-center p-3">
                            <i class="fas fa-cash-register mr-2"></i> Record New Sale
                        </a>
                    </div>
                    {% endif %}
                    <div class="col-sm-6 p-2">
                        <a href="{{ url_for('inventory') }}" class="btn btn-secondary d-flex align-items-center justify-content-center p-3">
                            <i class="fas fa-boxes mr-2"></i> View Inventory
                        </a>
                    </div>
                    <div class="col-sm-6 p-2">
                        <a href="{{ url_for('reports') }}" class="btn btn-secondary d-flex align-items-center justify-content-center p-3">
                            <i class="fas fa-chart-line mr-2"></i> View Reports
                        </a>
                    </div>
                    {% if user_role == 'admin' %}
                    <div class="col-sm-6 p-2">
                        <a href="{{ url_for('manage_business_users') }}" class="btn btn-secondary d-flex align-items-center justify-content-center p-3">
                            <i class="fas fa-users mr-2"></i> Manage Users
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Business Overview Card #}
        <div class="col-lg-6 mb-4">
            <div class="card p-3">
                <h3 class="h5 font-weight-semibold text-dark mb-3">Business Overview</h3>
                <div class="row no-gutters">
                    <div class="col-sm-6 p-2">
                        <div class="p-3 rounded shadow-sm text-center bg-light">
                            <p class="small font-weight-medium text-info">Total Products:</p>
                            <p class="h4 font-weight-bold text-primary">{{ total_products }}</p>
                        </div>
                    </div>
                    <div class="col-sm-6 p-2">
                        <div class="p-3 rounded shadow-sm text-center bg-light">
                            <p class="small font-weight-medium text-info">Total Customers:</p>
                            <p class="h4 font-weight-bold text-primary">{{ total_customers }}</p>
                        </div>
                    </div>
                </div>
                <hr class="my-3">
                <h6 class="font-weight-semibold text-dark mb-2">Sales Metrics:</h6>
                <div class="row no-gutters mb-3">
                    <div class="col-sm-6 p-2">
                        <div class="p-3 rounded shadow-sm text-center bg-light">
                            <p class="small font-weight-medium text-success">Sales Today:</p>
                            <p class="h5 font-weight-bold text-success">GH‚Çµ{{ "%.2f" | format(total_sales_today) }}</p>
                        </div>
                    </div>
                    <div class="col-sm-6 p-2">
                        <div class="p-3 rounded shadow-sm text-center bg-light">
                            <p class="small font-weight-medium text-success">Overall Sales:</p>
                            <p class="h5 font-weight-bold text-success">GH‚Çµ{{ "%.2f" | format(total_sales_overall) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Synchronization Card - Visible only to Admins #}
    {% if user_role == 'admin' %}
    <div class="card p-3 mb-4">
        <h3 class="h5 font-weight-semibold text-dark mb-3">Data Synchronization</h3>
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-sync-alt mr-2"></i>
            <span id="syncStatusText" class="font-weight-bold">Checking status...</span>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <span id="lastSyncTime" class="text-muted small">Last Sync: N/A</span>
            <button id="triggerSyncBtn" class="btn btn-info btn-sm">
                <i class="fas fa-arrows-alt-h mr-1"></i> Sync Now
            </button>
        </div>
        <div id="syncMessage" class="mt-2" style="display: none;"></div>
    </div>
    {% endif %}
    
    {# Low Stock and Expiring Items #}
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card p-3">
                <h3 class="h5 font-weight-semibold text-dark mb-3">Low Stock Alerts (Below 10 units)</h3>
                {% if low_stock_items %}
                    <ul class="list-group list-group-flush">
                        {% for item in low_stock_items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ item.item_name }}
                                <span class="badge badge-warning badge-pill">{{ "%.2f" | format(item.current_stock) }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No low stock items found. All good! üëç</p>
                {% endif %}
            </div>
        </div>

        {% if business_type == 'Pharmacy' %}
        <div class="col-lg-6 mb-4">
            <div class="card p-3">
                <h3 class="h5 font-weight-semibold text-dark mb-3">Expiring Items (Next 90 Days)</h3>
                {% if expiring_soon_items %}
                    <ul class="list-group list-group-flush">
                        {% for item in expiring_soon_items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ item.item_name }}
                                <span class="badge badge-warning badge-pill">Expires: {{ item.expiry_date.strftime('%Y-%m-%d') }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No items expiring in the next 90 days. All clear! ‚ú®</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    {# Sales by Sales Person (Today) Card #}
    <div class="card p-3 mb-4">
        <h3 class="h5 font-weight-semibold text-dark mb-3">Sales by Sales Person (Today)</h3>
        {% if sales_by_person_today %}
            <ul class="list-group list-group-flush">
            {% for person, total_sales in sales_by_person_today %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="h6 text-dark">{{ person }}:</span>
                    <span class="h6 font-weight-bold text-dark">GH‚Çµ{{ "%.2f" | format(total_sales) }}</span>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No sales recorded by sales persons today.</p>
        {% endif %}
    </div>

    {# Hardware Specific Metrics (if applicable) #}
    {% if business_type == 'Hardware' %}
    <div class="card p-3 mb-4">
        <h3 class="h5 font-weight-semibold text-dark mb-3">Hardware Business Metrics</h3>
        {% if overdue_rentals %}
            <p class="text-danger">You have {{ overdue_rentals | length }} overdue rentals!</p>
            <ul class="list-group list-group-flush">
                {% for rental in overdue_rentals %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="text-dark">Rental ID: {{ rental.id }}</span>
                        <span class="badge badge-danger">Due: {{ rental.due_date.strftime('%Y-%m-%d') }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No overdue rentals. All rentals are up to date. üëç</p>
        {% endif %}
    </div>
    {% endif %}

    {# Recent Activity Card #}
    <div class="card p-3">
        <h3 class="h5 font-weight-semibold text-dark mb-3">Recent Activity</h3>
        {% if recent_activity %}
            <ul class="list-group list-group-flush">
                {% for record in recent_activity %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <p class="mb-0">{{ record.sales_person_name }} made a sale for GH‚Çµ{{ "%.2f" | format(record.grand_total_amount) }}</p>
                    <small class="text-muted">{{ record.transaction_date.strftime('%Y-%m-%d %H:%M') }}</small>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No recent activity found.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }} {# Keep any scripts from base.html #}
    <script>
    $(document).ready(function() {
        // Function to fetch and display sync status
        function fetchSyncStatus() {
            $.ajax({
                url: "{{ url_for('sync_status') }}",
                type: 'GET',
                success: function(response) {
                    $('#syncStatusText').text('Status: ' + response.status);
                    $('#lastSyncTime').text('Last Sync: ' + (response.last_sync !== '1970-01-01T00:00:00Z' ? new Date(response.last_sync).toLocaleString() : 'Never'));
                },
                error: function(xhr) {
                    console.error("Error fetching sync status:", xhr.responseText);
                    $('#syncStatusText').text('Status: Error fetching sync status');
                    var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : "Could not fetch sync status.";
                    displayFlashMessage('danger', '<i class="fas fa-times-circle"></i> ' + errorMessage);
                }
            });
        }

        // Function to display dynamic flash messages on the page
        function displayFlashMessage(category, message) {
            $('.dynamic-flash-message').remove();
            var flashHtml = `
                <div class="flash-message flash-${category} rounded p-3 mb-3 shadow-sm dynamic-flash-message">
                    ${message}
                </div>
            `;
            $('.container.py-4').find('.alert.alert-info').after(flashHtml);
            setTimeout(function() {
                $('.dynamic-flash-message').fadeOut('slow', function() {
                    $(this).remove();
                });
            }, 5000);
        }

        // Trigger sync button click handler
        $('#triggerSyncBtn').on('click', function() {
            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Syncing...');
            $('#syncMessage').hide().removeClass('alert alert-success alert-danger').empty();

            $.ajax({
                url: "{{ url_for('trigger_sync') }}",
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('meta[name="csrf-token"]').attr('content') // Include CSRF token
                },
                success: function(response) {
                    displayFlashMessage('success', '<i class="fas fa-check-circle"></i> ' + response.message);
                    fetchSyncStatus(); // Update status after successful sync
                },
                error: function(xhr) {
                    console.error("Error triggering sync:", xhr.responseText);
                    var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : "An unknown error occurred during sync.";
                    displayFlashMessage('danger', '<i class="fas fa-times-circle"></i> ' + errorMessage);
                },
                complete: function() {
                    $('#triggerSyncBtn').prop('disabled', false).html('<i class="fas fa-arrows-alt-h mr-1"></i> Sync Now');
                }
            });
        });

        // Initial fetch of sync status when page loads, only if sync card is present
        if ($('#syncStatusText').length) {
            fetchSyncStatus();
        }

        // You might also want to set up an interval to periodically fetch status
        // setInterval(fetchSyncStatus, 60000); // Every 60 seconds (1 minute)
    });
    </script>
{% endblock %}