<!-- templates/sales_list.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Records - Pharmaceutical Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
         <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
   
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        /* CSS for printing all sales records */
        @media print {
            body {
                background-color: #fff; /* Ensure body background is white */
                color: #000; /* Ensure text is black */
                margin: 0;
                padding: 0;
            }
            body > *:not(#print-all-sales-area) {
                display: none;
            }
            #print-all-sales-area {
                display: block !important; /* Force visibility */
                width: 100%;
                margin: 0;
                padding: 20px;
                box-sizing: border-box;
                font-size: 12px;
                color: #000;
            }
            #print-all-sales-area table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            #print-all-sales-area th,
            #print-all-sales-area td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            #print-all-sales-area h2 {
                text-align: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 bg-gray-100">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-5xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Daily Sales Records</h2>
            <div class="flex space-x-3">
                {% if user_role in ['admin', 'sales'] %} {# Only admin/sales can add #}
                <a href="{{ url_for('add_sale') }}"
                   class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out"
                >
                    Add New Sale
                </a>
                <a href="{{ url_for('return_item') }}"
                   class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out"
                >
                    Return Item
                </a>
                {% endif %}
                <button onclick="printAllSales()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out"
                >
                    Print All Sales
                </button>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                    {% for category, message in messages %}
                        <div class="p-3 mb-2 rounded-md
                            {% if category == 'success' %} bg-green-100 text-green-700
                            {% elif category == 'danger' %} bg-red-100 text-red-700
                            {% elif category == 'warning' %} bg-yellow-100 text-yellow-700
                            {% else %} bg-blue-100 text-blue-700 {% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% if sales %}
        <div class="overflow-x-auto rounded-lg shadow-md">
            <table class="min-w-full divide-y divide-gray-200" id="sales-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref. No.</th> {# New column #}
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity Sold</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Type</th> {# New column #}
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price per Unit (GH₵)</th> {# Renamed column #}
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount (GH₵)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sale Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Phone</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales Personnel</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for sale in sales %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ sale.get('reference_number', 'N/A') }}</td> {# Display new field #}
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ sale.product_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "%.2f"|format(sale.quantity_sold|float) }}</td> {# Display as float #}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ sale.get('sale_unit_type', 'N/A') | capitalize }}</td> {# Display new field #}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "%.2f"|format(sale.price_at_time_per_unit_sold|float) }}</td> {# Display new field #}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "%.2f"|format(sale.total_amount|float) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ sale.sale_date }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ sale.get('customer_phone', 'N/A') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ sale.get('sales_person_name', 'N/A') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            {% if user_role in ['admin', 'sales'] %} {# Only admin/sales can edit/delete #}
                            <a href="{{ url_for('edit_sale', sale_id=sale.id) }}" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</a>
                            <a href="{{ url_for('delete_sale', sale_id=sale.id) }}" class="text-red-600 hover:text-red-900" onclick="return confirm('Are you sure you want to delete this sale record? This will adjust stock.');">Delete</a>
                            {% else %}
                            <span class="text-gray-400">No Actions</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-gray-500 text-lg py-8">No sales records found. Add a sale!</p>
        {% endif %}

        <div class="mt-8 text-center">
            <a href="{{ url_for('dashboard') }}"
               class="inline-block bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out"
            >
                Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Print Area for All Sales -->
    <div id="print-all-sales-area" style="display: none;">
        <h2>Daily Sales Records - Printout</h2>
        <p>Date: <span id="print-all-sales-date"></span></p>
        <!-- Table content will be injected here by JavaScript -->
    </div>

    <script>
        function printAllSales() {
            const salesTable = document.getElementById('sales-table');
            const printArea = document.getElementById('print-all-sales-area');
            const printDateSpan = document.getElementById('print-all-sales-date');

            if (!salesTable) {
                showCustomAlert('No sales records to print.');
                return;
            }

            // Clone the table for printing
            const tableClone = salesTable.cloneNode(true);
            
            // Remove the 'Actions' column from the cloned table for printing
            const ths = tableClone.querySelectorAll('thead th');
            if (ths.length > 0) { // Check if there are any headers
                ths[ths.length - 1].remove(); // Remove last th (Actions)
            }
            tableClone.querySelectorAll('tbody tr').forEach(row => {
                if (row.lastElementChild) { // Check if there's a last element
                    row.lastElementChild.remove(); // Remove last td (Actions)
                }
            });

            // Set the print date
            const now = new Date();
            const formattedDate = now.toLocaleString(); // Get current date and time
            printDateSpan.textContent = formattedDate;

            // Clear previous content and append the cloned table
            printArea.innerHTML = ''; // Clear existing content
            printArea.appendChild(document.createElement('h2')).textContent = 'Daily Sales Records - Printout';
            printArea.appendChild(document.createElement('p')).innerHTML = 'Date: <span id="print-all-sales-date-dynamic">' + formattedDate + '</span>';
            printArea.appendChild(tableClone);


            window.print();
        }

        // Custom alert function (re-used from add_edit_sale.html for consistency)
        function showCustomAlert(message) {
            let alertDiv = document.getElementById('custom-alert');
            if (!alertDiv) {
                alertDiv = document.createElement('div');
                alertDiv.id = 'custom-alert';
                alertDiv.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform scale-0 opacity-0';
                document.body.appendChild(alertDiv);
            }
            alertDiv.textContent = message;
            alertDiv.classList.remove('scale-0', 'opacity-0');
            alertDiv.classList.add('scale-100', 'opacity-100');
            setTimeout(() => {
                alertDiv.classList.remove('scale-100', 'opacity-100');
                alertDiv.classList.add('scale-0', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
