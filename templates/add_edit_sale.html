{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-md">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">{{ title }}</h2>

    {% if print_ready and last_transaction_details %}
    <div id="receipt-section" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6 border border-gray-200">
        <h3 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Sales Receipt</h3>
        <div class="text-sm text-gray-600 mb-4 text-center">
            <p class="font-bold text-lg text-gray-800">{{ pharmacy_info.name }}</p>
            <p>{{ pharmacy_info.address }}, {{ pharmacy_info.location }}</p>
            <p>Contact: {{ pharmacy_info.contact }}</p>
            <p class="mt-2">Transaction ID: <span class="font-mono text-blue-700">{{ last_transaction_id }}</span></p>
            <p>Date: {{ last_transaction_date }}</p>
            <p>Sales Person: {{ last_transaction_sales_person }}</p>
            {% if last_transaction_customer_phone %}
            <p>Customer Phone: {{ last_transaction_customer_phone }}</p>
            {% endif %}
        </div>

        <table class="min-w-full bg-white rounded-lg overflow-hidden mb-4">
            <thead class="bg-gray-100">
                <tr>
                    <th class="py-2 px-4 text-left text-sm font-medium text-gray-600">Product</th>
                    <th class="py-2 px-4 text-left text-sm font-medium text-gray-600">Qty</th>
                    <th class="py-2 px-4 text-left text-sm font-medium text-gray-600">Unit Price</th>
                    <th class="py-2 px-4 text-right text-sm font-medium text-gray-600">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in last_transaction_details %}
                <tr class="border-b border-gray-200 last:border-b-0">
                    <td class="py-2 px-4 text-sm text-gray-800">{{ item.product_name }}</td>
                    <td class="py-2 px-4 text-sm text-gray-800">{{ item.quantity_sold }} {{ item.sale_unit_type }}</td>
                    <td class="py-2 px-4 text-sm text-gray-800">GH₵{{ "%.2f" | format(item.price_at_time_per_unit_sold) }}</td>
                    <td class="py-2 px-4 text-right text-sm text-gray-800">GH₵{{ "%.2f" | format(item.total_amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="bg-gray-100">
                <tr>
                    <td colspan="3" class="py-2 px-4 text-right text-base font-semibold text-gray-800">Grand Total:</td>
                    <td class="py-2 px-4 text-right text-base font-bold text-gray-900">GH₵{{ "%.2f" | format(last_transaction_grand_total) }}</td>
                </tr>
            </tfoot>
        </table>
        <div class="text-center mt-6">
            <button onclick="window.print()" class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md mr-4">
                <i class="fas fa-print mr-2"></i> Print Receipt
            </button>
            <a href="{{ url_for('add_sale') }}" class="btn btn-secondary bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-md">
                <i class="fas fa-plus-circle mr-2"></i> New Sale
            </a>
        </div>
    </div>
    {% endif %}

    <form method="POST" action="{{ url_for('add_sale') }}" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
                <label for="customer_phone" class="block text-sm font-medium text-gray-700 mb-1">Customer Phone (Optional)</label>
                <input type="text" id="customer_phone" name="customer_phone" value="{{ sale.customer_phone | default('') }}"
                       class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2">
            </div>
            <div class="form-group">
                <label for="sales_person_name" class="block text-sm font-medium text-gray-700 mb-1">Sales Person</label>
                <input type="text" id="sales_person_name" name="sales_person_name" value="{{ sale.sales_person_name | default(session.username) }}"
                       class="form-input mt-1 block w-full rounded-md border-gray-300 bg-gray-100 cursor-not-allowed shadow-sm p-2" readonly>
            </div>
        </div>

        <h3 class="text-xl font-semibold text-gray-800 mb-4">Items to Sell</h3>

        <div id="cart-items-container" class="space-y-4">
            <!-- Dynamic cart items will be added here -->
        </div>

        <button type="button" id="add-another-item-btn" class="btn btn-primary bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md">
            <i class="fas fa-plus-circle mr-2"></i> Add Another Item
        </button>

        <div class="mt-6 text-right">
            <p class="text-2xl font-bold text-gray-900">Grand Total: GH₵<span id="grand-total">0.00</span></p>
        </div>

        <div class="form-group mt-6 flex items-center">
            <input type="checkbox" id="send_sms_receipt" name="send_sms_receipt" class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4">
            <label for="send_sms_receipt" class="ml-2 text-sm text-gray-700">Send SMS Receipt to Customer</label>
        </div>

        <input type="hidden" name="cart_items_json" id="cart-items-json">

        <div class="flex justify-end space-x-4 mt-8">
            <a href="{{ url_for('sales') }}" class="btn btn-secondary bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md">
                Cancel
            </a>
            <button type="submit" class="btn btn-success bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md">
                <i class="fas fa-cash-register mr-2"></i> Record Sale
            </button>
        </div>
    </form>
</div>

<script>
    const inventoryItems = {{ inventory_items | tojson }};
    const cartItemsContainer = document.getElementById('cart-items-container');
    const addAnotherItemBtn = document.getElementById('add-another-item-btn');
    const grandTotalSpan = document.getElementById('grand-total');
    const cartItemsJsonInput = document.getElementById('cart-items-json');

    let cart = []; // Array to hold all items in the cart

    // Function to calculate markup percentage for Pharmacy type
    function calculateMarkupPercentage(purchasePrice, salePrice) {
        if (purchasePrice > 0) {
            return ((salePrice - purchasePrice) / purchasePrice) * 100;
        }
        return 0;
    }

    // Function to create a new item row
    function createItemRow(item = {}) {
        const row = document.createElement('div');
        row.className = 'item-row grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 bg-gray-50 p-4 rounded-md shadow-sm border border-gray-200 relative';
        row.innerHTML = `
            <div class="form-group col-span-full md:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">Product</label>
                <select class="product-select form-input w-full p-2 rounded-md border-gray-300"></select>
            </div>
            <div class="form-group">
                <label class="block text-xs font-medium text-gray-600 mb-1">Unit Type</label>
                <select class="unit-type-select form-input w-full p-2 rounded-md border-gray-300">
                    <option value="pack">Pack</option>
                    <option value="tab">Tab</option>
                </select>
            </div>
            <div class="form-group">
                <label class="block text-xs font-medium text-gray-600 mb-1">Quantity</label>
                <input type="number" step="any" min="0" class="quantity-input form-input w-full p-2 rounded-md border-gray-300" value="0">
            </div>
            <div class="form-group">
                <label class="block text-xs font-medium text-gray-600 mb-1">Unit Price (GH₵)</label>
                <input type="number" step="0.01" min="0" class="unit-price-input form-input w-full p-2 rounded-md border-gray-300" value="0.00">
            </div>
            <div class="form-group col-span-full md:col-span-1 flex items-end justify-between">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Item Total (GH₵)</label>
                    <input type="text" class="item-total-display form-input w-full p-2 rounded-md border-gray-300 bg-gray-100 cursor-not-allowed" value="0.00" readonly>
                </div>
                <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 focus:outline-none p-2 rounded-full">
                    <i class="fas fa-times-circle text-xl"></i>
                </button>
            </div>
        `;

        const productSelect = row.querySelector('.product-select');
        const unitTypeSelect = row.querySelector('.unit-type-select');
        const quantityInput = row.querySelector('.quantity-input');
        const unitPriceInput = row.querySelector('.unit-price-input');
        const itemTotalDisplay = row.querySelector('.item-total-display');
        const removeItemBtn = row.querySelector('.remove-item-btn');

        // Populate product dropdown
        let defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select a Product';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        productSelect.appendChild(defaultOption);

        inventoryItems.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = `${item.product_name} (Stock: ${item.current_stock})`;
            productSelect.appendChild(option);
        });

        // Event Listeners
        productSelect.addEventListener('change', () => {
            const selectedProduct = inventoryItems.find(item => item.id === productSelect.value);
            if (selectedProduct) {
                // Set default unit type based on business type, then update prices
                if ('{{ business_type }}' === 'Pharmacy') {
                    unitTypeSelect.innerHTML = `
                        <option value="pack">Pack</option>
                        <option value="tab">Tab</option>
                    `;
                } else {
                    unitTypeSelect.innerHTML = `
                        <option value="pack">Pack</option>
                        <option value="piece">Piece</option>
                    `;
                }
                unitTypeSelect.value = selectedProduct.item_type === 'Pharmacy' ? 'pack' : 'pack'; // Default to pack/piece

                updatePrices(selectedProduct, unitTypeSelect.value, unitPriceInput);
            } else {
                unitPriceInput.value = '0.00';
            }
            calculateItemTotal(quantityInput, unitPriceInput, itemTotalDisplay);
            updateGrandTotal();
        });

        unitTypeSelect.addEventListener('change', () => {
            const selectedProduct = inventoryItems.find(item => item.id === productSelect.value);
            if (selectedProduct) {
                updatePrices(selectedProduct, unitTypeSelect.value, unitPriceInput);
            }
            calculateItemTotal(quantityInput, unitPriceInput, itemTotalDisplay);
            updateGrandTotal();
        });

        quantityInput.addEventListener('input', () => {
            // Client-side stock validation
            const selectedProduct = inventoryItems.find(item => item.id === productSelect.value);
            if (selectedProduct) {
                const requestedQuantity = parseFloat(quantityInput.value);
                let availableStock = selectedProduct.current_stock;
                if (unitTypeSelect.value === 'tab' && selectedProduct.number_of_tabs > 0) {
                    availableStock = selectedProduct.current_stock * selectedProduct.number_of_tabs;
                }

                if (requestedQuantity > availableStock) {
                    alert(`Insufficient stock for ${selectedProduct.product_name}. Available: ${availableStock}.`);
                    quantityInput.value = availableStock; // Cap at available stock
                }
            }
            calculateItemTotal(quantityInput, unitPriceInput, itemTotalDisplay);
            updateGrandTotal();
        });

        unitPriceInput.addEventListener('input', () => {
            calculateItemTotal(quantityInput, unitPriceInput, itemTotalDisplay);
            updateGrandTotal();
        });

        removeItemBtn.addEventListener('click', () => {
            row.remove();
            updateGrandTotal();
        });

        // If item data is provided (for editing or pre-populating)
        if (Object.keys(item).length > 0) {
            productSelect.value = item.product_id;
            // Trigger change to populate unit types and initial prices
            const event = new Event('change');
            productSelect.dispatchEvent(event);

            unitTypeSelect.value = item.sale_unit_type;
            quantityInput.value = item.quantity_sold;
            unitPriceInput.value = item.price_at_time_per_unit_sold;

            // Recalculate and set item total
            calculateItemTotal(quantityInput, unitPriceInput, itemTotalDisplay);
        }

        return row;
    }

    function updatePrices(product, unitType, unitPriceInput) {
        let price = 0;
        if (product.is_fixed_price) {
            if (unitType === 'tab' && product.number_of_tabs > 0) {
                price = product.fixed_sale_price / product.number_of_tabs;
            } else {
                price = product.fixed_sale_price;
            }
        } else {
            if (unitType === 'tab' && product.number_of_tabs > 0) {
                price = product.unit_price_per_tab;
            } else {
                price = product.sale_price;
            }
        }
        unitPriceInput.value = price.toFixed(2);
    }

    function calculateItemTotal(quantityInput, unitPriceInput, itemTotalDisplay) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        const itemTotal = quantity * unitPrice;
        itemTotalDisplay.value = itemTotal.toFixed(2);
    }

    function updateGrandTotal() {
        let total = 0;
        const itemRows = cartItemsContainer.querySelectorAll('.item-row');
        cart = []; // Clear and rebuild cart array

        itemRows.forEach(row => {
            const productId = row.querySelector('.product-select').value;
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price-input').value) || 0;
            const itemTotal = parseFloat(row.querySelector('.item-total-display').value) || 0;
            const unitType = row.querySelector('.unit-type-select').value;

            if (productId && quantity > 0 && unitPrice > 0) {
                total += itemTotal;
                cart.push({
                    product_id: productId,
                    quantity_sold: quantity,
                    sale_unit_type: unitType,
                    price_at_time_per_unit_sold: unitPrice,
                    item_total_amount: itemTotal
                });
            }
        });
        grandTotalSpan.textContent = total.toFixed(2);
        cartItemsJsonInput.value = JSON.stringify(cart); // Update hidden input for Flask
    }

    addAnotherItemBtn.addEventListener('click', () => {
        cartItemsContainer.appendChild(createItemRow());
        updateGrandTotal();
    });

    // Initial row when page loads
    document.addEventListener('DOMContentLoaded', () => {
        // If there are last transaction details (for receipt printing), don't add a new row immediately
        // The receipt section is handled separately.
        if (!document.getElementById('receipt-section')) {
            cartItemsContainer.appendChild(createItemRow());
        } else {
            // If we are showing a receipt, we don't want to show the sales form by default.
            // The user will click "New Sale" to get to the form.
            document.querySelector('form').style.display = 'none';
        }
        updateGrandTotal();
    });

    // Handle initial items if editing an existing sale (though current Flask logic doesn't support multi-item edit directly)
    // This part would be expanded if the 'edit_sale' route sent a list of items.
    // For 'add_sale' with print_ready, the receipt logic handles display.
    {% if last_transaction_details %}
        // If we are showing a receipt, the form should be hidden initially
        document.querySelector('form').style.display = 'none';
    {% elif sale.items %}
        // This block is for pre-populating items if the 'sale' object came with items (e.g., on form error re-render)
        cartItemsContainer.innerHTML = ''; // Clear any default row
        sale.items.forEach(item => {
            cartItemsContainer.appendChild(createItemRow(item));
        });
        updateGrandTotal();
    {% endif %}

</script>
{% endblock %}
