<!-- templates/add_edit_sale.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Pharmaceutical Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .form-group label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
            display: block;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group input[type="tel"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.375rem;
            font-size: 1rem;
            color: #2d3748;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group input[type="tel"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            outline: none;
        }
        .product-row {
            border: 1px solid #e2e8f0;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            background-color: #f7fafc;
        }
        .product-row:last-of-type {
            margin-bottom: 0;
        }
        .print-area {
            display: none; /* Hidden by default */
        }
        @media print {
            body > *:not(.print-area) {
                display: none;
            }
            .print-area {
                display: block;
                width: 100%;
                margin: 0 auto;
                padding: 20px;
                font-family: 'Inter', sans-serif;
                color: #000;
                font-size: 12px;
            }
            .print-area h2, .print-area h3 {
                text-align: center;
                margin-bottom: 10px;
            }
            .print-area table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 15px;
            }
            .print-area th, .print-area td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            .print-area .text-right {
                text-align: right;
            }
            .print-area .text-center {
                text-align: center;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 bg-gray-100">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">{{ title }}</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                    {% for category, message in messages %}
                        <div class="p-3 mb-2 rounded-md
                            {% if category == 'success' %} bg-green-100 text-green-700
                            {% elif category == 'danger' %} bg-red-100 text-red-700
                            {% elif category == 'warning' %} bg-yellow-100 text-yellow-700
                            {% else %} bg-blue-100 text-blue-700 {% endif %}">
                            {{ message | safe }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form action="{{ url_for('add_sale') if not sale.id else url_for('edit_sale', sale_id=sale.id) }}" method="POST">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="form-group">
                    <label for="customer_phone">Customer Phone (Optional)</label>
                    <input type="tel" id="customer_phone" name="customer_phone" value="{{ sale.customer_phone if sale.customer_phone else '' }}" class="mt-1">
                </div>
                <div class="form-group">
                    <label for="sales_person_name">Sales Person</label>
                    <input type="text" id="sales_person_name" name="sales_person_name" value="{{ sale.sales_person_name if sale.sales_person_name else username }}" class="mt-1" readonly>
                </div>
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mb-4">Products Sold</h3>

            <div class="mb-4">
                <label for="product_search" class="block text-sm font-medium text-gray-700">Search Product</label>
                <input
                    type="text"
                    id="product_search"
                    placeholder="Type to search products..."
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    oninput="filterProductOptions()"
                >
            </div>

            <div id="products-container">
                <!-- Product rows will be added here by JavaScript -->
                {% if sale.id %}
                    <!-- For editing an existing sale, populate with its single item -->
                    <div class="product-row grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4 p-4 border rounded-lg bg-gray-50">
                        <div class="form-group">
                            <label for="product_id_0">Product</label>
                            <select id="product_id_0" name="product_id[]" class="mt-1 product-select w-full p-2 border rounded-md" required onchange="updateProductDetails(this, 0)">
                                <option value="">Select Product</option>
                                {% for item in inventory_items %}
                                    <option value="{{ item.id }}" data-sale-price="{{ item.sale_price }}" data-unit-price-per-tab="{{ item.unit_price_per_tab }}" data-number-of-tabs="{{ item.number_of_tabs }}" data-is-fixed-price="{{ 'true' if item.is_fixed_price else 'false' }}" data-fixed-sale-price="{{ item.fixed_sale_price }}" data-item-type="{{ item.item_type }}" {% if sale.product_id == item.id %}selected{% endif %}>
                                        {{ item.product_name }} ({{ "%.2f" | format(item.current_stock) }} {{ 'packs' if business_type != 'Hardware' else 'units' }} in stock)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity_sold_0">Quantity</label>
                            <input type="number" id="quantity_sold_0" name="quantity_sold[]" step="0.01" min="0.01" value="{{ sale.quantity_sold }}" class="mt-1 quantity-input w-full p-2 border rounded-md" required oninput="calculateItemTotal(0)">
                        </div>
                        <div class="form-group">
                            <label for="sale_unit_type_0">Unit Type</label>
                            <select id="sale_unit_type_0" name="sale_unit_type[]" class="mt-1 unit-type-select w-full p-2 border rounded-md" required onchange="calculateItemTotal(0)">
                                <option value="pack" {% if sale.sale_unit_type == 'pack' %}selected{% endif %}>{{ 'Pack(s)' if business_type != 'Hardware' else 'Unit(s)' }}</option>
                                <option value="tab" {% if sale.sale_unit_type == 'tab' %}selected{% endif %}>{{ 'Tab(s)' if business_type != 'Hardware' else 'Piece(s)' }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="price_type_0">Price Type</label>
                            <select id="price_type_0" name="price_type[]" class="mt-1 price-type-select w-full p-2 border rounded-md" required onchange="toggleCustomPrice(0)">
                                <option value="internal_percentage" {% if sale.price_type == 'internal_percentage' %}selected{% endif %}>Internal Percentage</option>
                                {% if user_role == 'admin' %}
                                <option value="custom_price" {% if sale.price_type == 'custom_price' %}selected{% endif %}>Custom Price</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="form-group col-span-2">
                            <label for="custom_price_0">Custom Price (per {{ 'pack/unit' if business_type != 'Hardware' else 'unit/piece' }})</label>
                            <input type="number" id="custom_price_0" name="custom_price[]" step="0.01" min="0" value="{{ sale.custom_price }}" class="mt-1 custom-price-input w-full p-2 border rounded-md" style="display: {{ 'block' if sale.price_type == 'custom_price' else 'none' }};" oninput="calculateItemTotal(0)">
                        </div>
                        <div class="form-group">
                            <label for="item_total_0">Item Total</label>
                            <input type="text" id="item_total_0" name="item_total[]" value="{{ '%.2f' | format(sale.total_amount) }}" class="mt-1 item-total-display w-full p-2 border rounded-md bg-gray-200" readonly>
                        </div>
                        <div class="form-group">
                            <button type="button" onclick="removeItemRow(this)" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out w-full">Remove</button>
                        </div>
                    </div>
                {% else %}
                    <!-- For adding new sales, start with one empty row -->
                    <div class="product-row grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4 p-4 border rounded-lg bg-gray-50">
                        <div class="form-group">
                            <label for="product_id_0">Product</label>
                            <select id="product_id_0" name="product_id[]" class="mt-1 product-select w-full p-2 border rounded-md" required onchange="updateProductDetails(this, 0)">
                                <option value="">Select Product</option>
                                {% for item in inventory_items %}
                                    <option value="{{ item.id }}" data-sale-price="{{ item.sale_price }}" data-unit-price-per-tab="{{ item.unit_price_per_tab }}" data-number-of-tabs="{{ item.number_of_tabs }}" data-is-fixed-price="{{ 'true' if item.is_fixed_price else 'false' }}" data-fixed-sale-price="{{ item.fixed_sale_price }}" data-item-type="{{ item.item_type }}">
                                        {{ item.product_name }} ({{ "%.2f" | format(item.current_stock) }} {{ 'packs' if business_type != 'Hardware' else 'units' }} in stock)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity_sold_0">Quantity</label>
                            <input type="number" id="quantity_sold_0" name="quantity_sold[]" step="0.01" min="0.01" value="" class="mt-1 quantity-input w-full p-2 border rounded-md" required oninput="calculateItemTotal(0)">
                        </div>
                        <div class="form-group">
                            <label for="sale_unit_type_0">Unit Type</label>
                            <select id="sale_unit_type_0" name="sale_unit_type[]" class="mt-1 unit-type-select w-full p-2 border rounded-md" required onchange="calculateItemTotal(0)">
                                <option value="pack">{{ 'Pack(s)' if business_type != 'Hardware' else 'Unit(s)' }}</option>
                                <option value="tab">{{ 'Tab(s)' if business_type != 'Hardware' else 'Piece(s)' }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="price_type_0">Price Type</label>
                            <select id="price_type_0" name="price_type[]" class="mt-1 price-type-select w-full p-2 border rounded-md" required onchange="toggleCustomPrice(0)">
                                <option value="internal_percentage">Internal Percentage</option>
                                {% if user_role == 'admin' %}
                                <option value="custom_price">Custom Price</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="form-group col-span-2">
                            <label for="custom_price_0">Custom Price (per {{ 'pack/unit' if business_type != 'Hardware' else 'unit/piece' }})</label>
                            <input type="number" id="custom_price_0" name="custom_price[]" step="0.01" min="0" value="" class="mt-1 custom-price-input w-full p-2 border rounded-md" style="display: none;" oninput="calculateItemTotal(0)">
                        </div>
                        <div class="form-group">
                            <label for="item_total_0">Item Total</label>
                            <input type="text" id="item_total_0" name="item_total[]" value="0.00" class="mt-1 item-total-display w-full p-2 border rounded-md bg-gray-200" readonly>
                        </div>
                        <div class="form-group">
                            <button type="button" onclick="removeItemRow(this)" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out w-full">Remove</button>
                        </div>
                    </div>
                {% endif %}
            </div>

            <button type="button" onclick="addProductRow()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out mt-4 mb-6">
                Add Another Product
            </button>

            <div class="form-group mt-6">
                <label for="grand_total">Grand Total</label>
                <input type="text" id="grand_total" name="grand_total" value="0.00" class="mt-1 w-full p-3 border-2 border-blue-400 rounded-md text-xl font-bold text-gray-800 bg-blue-50" readonly>
            </div>

            <div class="flex justify-end gap-4 mt-8">
                <a href="{{ url_for('sales') }}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out">Cancel</a>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out">
                    {{ 'Update Sale' if sale.id else 'Record Sale' }}
                </button>
            </div>
        </form>
    </div>

    <!-- Print-ready receipt area -->
    {% if print_ready %}
    <div class="print-area p-8 bg-white rounded-lg shadow-xl mt-8">
        <h2 class="text-2xl font-bold mb-2">{{ pharmacy_info.name }}</h2>
        <h3 class="text-lg mb-4">{{ pharmacy_info.location }}, {{ pharmacy_info.address }}</h3>
        <p class="text-center mb-4">Contact: {{ pharmacy_info.contact }}</p>

        <h3 class="text-xl font-bold mb-4">SALES RECEIPT</h3>
        <p><strong>Transaction ID:</strong> {{ last_transaction_id }}</p>
        <p><strong>Date:</strong> {{ last_transaction_date }}</p>
        <p><strong>Sales Person:</strong> {{ last_transaction_sales_person }}</p>
        {% if last_transaction_customer_phone %}
        <p><strong>Customer Phone:</strong> {{ last_transaction_customer_phone }}</p>
        {% endif %}
        <br>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Unit Price</th>
                    <th class="text-right">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in last_transaction_details %}
                <tr>
                    <td>{{ item.product_name }}</td>
                    <td class="text-right">{{ "%.2f" | format(item.quantity_sold) }} {{ 'tab(s)' if item.sale_unit_type == 'tab' else ('pack(s)' if business_type != 'Hardware' else 'unit(s)') }}</td>
                    <td class="text-right">GH₵{{ "%.2f" | format(item.price_at_time_per_unit_sold) }}</td>
                    <td class="text-right">GH₵{{ "%.2f" | format(item.total_amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3" class="text-right">Grand Total:</th>
                    <th class="text-right">GH₵{{ "%.2f" | format(last_transaction_grand_total) }}</th>
                </tr>
            </tfoot>
        </table>
        <p class="text-center mt-6">Thank you for your business!</p>
    </div>

    <div class="mt-4 flex gap-4">
        <button type="button" onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out">Print Receipt</button>
        <a href="{{ url_for('add_sale') }}" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out">New Sale</a>
    </div>
    {% endif %}

    <script>
        let productRowCounter = 0;
        // Store the original full list of inventory items
        const allInventoryItems = {{ inventory_items | tojson }};
        let filteredInventoryItems = [...allInventoryItems]; // Start with all items
        const userRole = "{{ user_role }}";
        const businessType = "{{ business_type }}";

        // Function to create a new product row HTML
        function createProductRow(index, itemData = null) {
            const isEditMode = itemData !== null;
            // Use filteredInventoryItems for rendering options
            const productOptions = filteredInventoryItems.map(item => {
                const selected = isEditMode && itemData.product_id === item.id ? 'selected' : '';
                const unitText = businessType !== 'Hardware' ? 'packs' : 'units';
                // Corrected: Use JavaScript's toFixed(2) for current_stock
                return `<option value="${item.id}" 
                                data-sale-price="${item.sale_price}" 
                                data-unit-price-per-tab="${item.unit_price_per_tab}" 
                                data-number-of-tabs="${item.number_of_tabs}" 
                                data-is-fixed-price="${item.is_fixed_price}" 
                                data-fixed-sale-price="${item.fixed_sale_price}" 
                                data-item-type="${item.item_type}" 
                                ${selected}>
                            ${item.product_name} (${item.current_stock.toFixed(2)} ${unitText} in stock)
                        </option>`;
            }).join('');

            const unitTypePackText = businessType !== 'Hardware' ? 'Pack(s)' : 'Unit(s)';
            const unitTypeTabText = businessType !== 'Hardware' ? 'Tab(s)' : 'Piece(s)';
            const priceUnitText = businessType !== 'Hardware' ? 'pack/unit' : 'unit/piece';

            const priceTypeOptions = `
                <option value="internal_percentage" ${isEditMode && itemData.price_type === 'internal_percentage' ? 'selected' : ''}>Internal Percentage</option>
                ${userRole === 'admin' ? `<option value="custom_price" ${isEditMode && itemData.price_type === 'custom_price' ? 'selected' : ''}>Custom Price</option>` : ''}
            `;

            const customPriceDisplay = isEditMode && itemData.price_type === 'custom_price' ? 'block' : 'none';
            const customPriceValue = isEditMode && itemData.custom_price ? itemData.custom_price : '';
            const quantityValue = isEditMode ? itemData.quantity_sold : '';
            const itemTotalValue = isEditMode ? itemData.total_amount.toFixed(2) : '0.00';

            return `
                <div class="product-row grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4 p-4 border rounded-lg bg-gray-50">
                    <div class="form-group">
                        <label for="product_id_${index}">Product</label>
                        <select id="product_id_${index}" name="product_id[]" class="mt-1 product-select w-full p-2 border rounded-md" required onchange="updateProductDetails(this, ${index})">
                            <option value="">Select Product</option>
                            ${productOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quantity_sold_${index}">Quantity</label>
                        <input type="number" id="quantity_sold_${index}" name="quantity_sold[]" step="0.01" min="0.01" value="${quantityValue}" class="mt-1 quantity-input w-full p-2 border rounded-md" required oninput="calculateItemTotal(${index})">
                    </div>
                    <div class="form-group">
                        <label for="sale_unit_type_${index}">Unit Type</label>
                        <select id="sale_unit_type_${index}" name="sale_unit_type[]" class="mt-1 unit-type-select w-full p-2 border rounded-md" required onchange="calculateItemTotal(${index})">
                            <option value="pack" ${isEditMode && itemData.sale_unit_type === 'pack' ? 'selected' : ''}>${unitTypePackText}</option>
                            <option value="tab" ${isEditMode && itemData.sale_unit_type === 'tab' ? 'selected' : ''}>${unitTypeTabText}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="price_type_${index}">Price Type</label>
                        <select id="price_type_${index}" name="price_type[]" class="mt-1 price-type-select w-full p-2 border rounded-md" required onchange="toggleCustomPrice(${index})">
                            ${priceTypeOptions}
                        </select>
                    </div>
                    <div class="form-group col-span-2">
                        <label for="custom_price_${index}">Custom Price (per ${priceUnitText})</label>
                        <input type="number" id="custom_price_${index}" name="custom_price[]" step="0.01" min="0" value="${customPriceValue}" class="mt-1 custom-price-input w-full p-2 border rounded-md" style="display: ${customPriceDisplay};" oninput="calculateItemTotal(${index})">
                    </div>
                    <div class="form-group">
                        <label for="item_total_${index}">Item Total</label>
                        <input type="text" id="item_total_${index}" name="item_total[]" value="${itemTotalValue}" class="mt-1 item-total-display w-full p-2 border rounded-md bg-gray-200" readonly>
                    </div>
                    <div class="form-group">
                        <button type="button" onclick="removeItemRow(this)" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out w-full">Remove</button>
                    </div>
                </div>
            `;
        }

        // Add a new product row
        function addProductRow() {
            productRowCounter++;
            const container = document.getElementById('products-container');
            container.insertAdjacentHTML('beforeend', createProductRow(productRowCounter));
            calculateGrandTotal(); // Recalculate grand total after adding a new row
        }

        // Remove a product row
        function removeItemRow(button) {
            const row = button.closest('.product-row');
            if (document.querySelectorAll('.product-row').length > 1) {
                row.remove();
                calculateGrandTotal();
            } else {
                alert('You must have at least one product in the sale.');
            }
        }

        // Update product details (e.g., prices, stock) when product selection changes
        function updateProductDetails(selectElement, index) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            // Find the actual inventory item from allInventoryItems based on selected value
            const selectedItem = allInventoryItems.find(item => item.id === selectedOption.value);

            const quantityInput = document.getElementById(`quantity_sold_${index}`);
            const unitTypeSelect = document.getElementById(`sale_unit_type_${index}`);
            const priceTypeSelect = document.getElementById(`price_type_${index}`);
            const customPriceInput = document.getElementById(`custom_price_${index}`);

            // Reset quantity and custom price
            quantityInput.value = '';
            customPriceInput.value = '';
            customPriceInput.style.display = 'none'; // Hide custom price by default

            if (!selectedItem) {
                // If no item is selected, disable/reset related fields
                unitTypeSelect.value = 'pack'; // Default
                unitTypeSelect.querySelector('option[value="tab"]').disabled = false; // Enable by default
                priceTypeSelect.value = 'internal_percentage';
                priceTypeSelect.querySelector('option[value="custom_price"]').disabled = false; // Enable by default
                calculateItemTotal(index);
                return;
            }

            // Set default unit type based on item type
            if (selectedItem.item_type === 'Hardware Material' || selectedItem.item_type === 'Provision Store' || selectedItem.item_type === 'Supermarket') {
                unitTypeSelect.value = 'pack'; // Default to 'unit' for hardware, 'pack' for supermarket/provision
                // Disable 'tab' option if it's a hardware/provision/supermarket item, unless it has multiple pieces
                const tabOption = unitTypeSelect.querySelector('option[value="tab"]');
                if (tabOption) {
                    if (selectedItem.number_of_tabs > 1) {
                        tabOption.disabled = false;
                        tabOption.textContent = businessType !== 'Hardware' ? 'Tab(s)' : 'Piece(s)';
                    } else {
                        tabOption.disabled = true;
                        tabOption.textContent = businessType !== 'Hardware' ? 'Tab(s) (N/A)' : 'Piece(s) (N/A)';
                    }
                }
            } else { // Pharmacy
                unitTypeSelect.value = 'pack'; // Default to pack for pharmacy
                const tabOption = unitTypeSelect.querySelector('option[value="tab"]');
                if (tabOption) {
                    tabOption.disabled = false;
                    tabOption.textContent = 'Tab(s)';
                }
            }

            // If fixed price, force 'internal_percentage' and hide custom price for non-admins
            if (selectedItem.is_fixed_price) {
                priceTypeSelect.value = 'internal_percentage';
                if (userRole !== 'admin') {
                    // Disable custom price option for non-admins if it's a fixed price item
                    const customPriceOption = priceTypeSelect.querySelector('option[value="custom_price"]');
                    if (customPriceOption) {
                        customPriceOption.disabled = true;
                    }
                }
            } else {
                // Enable custom price option if not fixed price (for admins)
                const customPriceOption = priceTypeSelect.querySelector('option[value="custom_price"]');
                if (customPriceOption) {
                    customPriceOption.disabled = false;
                }
            }

            calculateItemTotal(index);
        }

        // Toggle visibility of custom price input
        function toggleCustomPrice(index) {
            const priceTypeSelect = document.getElementById(`price_type_${index}`);
            const customPriceInput = document.getElementById(`custom_price_${index}`);
            if (priceTypeSelect.value === 'custom_price') {
                customPriceInput.style.display = 'block';
                customPriceInput.setAttribute('required', 'required');
            } else {
                customPriceInput.style.display = 'none';
                customPriceInput.removeAttribute('required');
                customPriceInput.value = ''; // Clear custom price if not used
            }
            calculateItemTotal(index);
        }

        // Calculate total for a single item row
        function calculateItemTotal(index) {
            const productSelect = document.getElementById(`product_id_${index}`);
            const quantityInput = document.getElementById(`quantity_sold_${index}`);
            const unitTypeSelect = document.getElementById(`sale_unit_type_${index}`);
            const priceTypeSelect = document.getElementById(`price_type_${index}`);
            const customPriceInput = document.getElementById(`custom_price_${index}`);
            const itemTotalDisplay = document.getElementById(`item_total_${index}`);

            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const selectedItem = allInventoryItems.find(item => item.id === selectedOption.value);

            if (!selectedItem) {
                itemTotalDisplay.value = '0.00';
                calculateGrandTotal();
                return;
            }

            const salePricePerPack = parseFloat(selectedItem.sale_price);
            const unitPricePerTab = parseFloat(selectedItem.unit_price_per_tab);
            const numberOfTabs = parseInt(selectedItem.number_of_tabs);
            const isFixedPrice = selectedItem.is_fixed_price;
            const fixedSalePrice = parseFloat(selectedItem.fixed_sale_price);

            let quantity = parseFloat(quantityInput.value);
            if (isNaN(quantity) || quantity <= 0) {
                itemTotalDisplay.value = '0.00';
                calculateGrandTotal();
                return;
            }

            let pricePerUnit = 0;
            if (priceTypeSelect.value === 'custom_price' && userRole === 'admin') {
                let customPrice = parseFloat(customPriceInput.value);
                if (isNaN(customPrice) || customPrice <= 0) {
                    // Fallback to internal percentage if custom price is invalid
                    if (unitTypeSelect.value === 'tab') {
                        pricePerUnit = isFixedPrice ? (fixedSalePrice / numberOfTabs) : unitPricePerTab;
                    } else {
                        pricePerUnit = isFixedPrice ? fixedSalePrice : salePricePerPack;
                    }
                } else {
                    pricePerUnit = customPrice;
                }
            } else {
                if (unitTypeSelect.value === 'tab') {
                    pricePerUnit = isFixedPrice ? (fixedSalePrice / numberOfTabs) : unitPricePerTab;
                } else {
                    pricePerUnit = isFixedPrice ? fixedSalePrice : salePricePerPack;
                }
            }

            let itemTotal = quantity * pricePerUnit;
            itemTotalDisplay.value = itemTotal.toFixed(2);
            calculateGrandTotal();
        }

        // Calculate grand total of all items
        function calculateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.item-total-display').forEach(input => {
                grandTotal += parseFloat(input.value || 0);
            });
            document.getElementById('grand_total').value = grandTotal.toFixed(2);
        }

        // Filter product options based on search input
        function filterProductOptions() {
            const searchQuery = document.getElementById('product_search').value.toLowerCase();
            filteredInventoryItems = allInventoryItems.filter(item => 
                item.product_name.toLowerCase().includes(searchQuery) ||
                item.category.toLowerCase().includes(searchQuery) ||
                (item.batch_number && item.batch_number.toLowerCase().includes(searchQuery))
            );

            // Update all product select dropdowns with filtered options
            document.querySelectorAll('.product-select').forEach((selectElement, index) => {
                const currentSelectedValue = selectElement.value; // Preserve current selection if possible
                const unitText = businessType !== 'Hardware' ? 'packs' : 'units';
                selectElement.innerHTML = '<option value="">Select Product</option>' +
                    filteredInventoryItems.map(item => {
                        const selected = (currentSelectedValue === item.id) ? 'selected' : '';
                        return `<option value="${item.id}" 
                                        data-sale-price="${item.sale_price}" 
                                        data-unit-price-per-tab="${item.unit_price_per_tab}" 
                                        data-number-of-tabs="${item.number_of_tabs}" 
                                        data-is-fixed-price="${item.is_fixed_price}" 
                                        data-fixed-sale-price="${item.fixed_sale_price}" 
                                        data-item-type="${item.item_type}" 
                                        ${selected}>
                                    ${item.product_name} (${item.current_stock.toFixed(2)} ${unitText} in stock)
                                </option>`;
                    }).join('');
                // If the previously selected item is no longer in the filtered list, clear selection
                if (currentSelectedValue && !filteredInventoryItems.some(item => item.id === currentSelectedValue)) {
                    selectElement.value = "";
                }
                updateProductDetails(selectElement, index); // Update details for the current selection
            });
        }


        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // If it's an add sale page (not edit), ensure there's at least one row
            if (!{{ 'true' if sale.id else 'false' }}) {
                if (document.querySelectorAll('.product-row').length === 0) {
                    addProductRow(); // Add an initial empty row if none exists
                }
            }

            // Re-calculate totals and set up event listeners for existing rows (e.g., on edit page)
            document.querySelectorAll('.product-row').forEach((row, index) => {
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.quantity-input');
                const unitTypeSelect = row.querySelector('.unit-type-select');
                const priceTypeSelect = row.querySelector('.price-type-select');
                const customPriceInput = row.querySelector('.custom-price-input');

                // Ensure initial state of custom price input is correct
                if (priceTypeSelect.value === 'custom_price') {
                    customPriceInput.style.display = 'block';
                } else {
                    customPriceInput.style.display = 'none';
                }

                // If in edit mode, ensure product details are updated and total calculated
                if (productSelect.value) {
                    updateProductDetails(productSelect, index);
                }
                calculateItemTotal(index);
            });
            calculateGrandTotal(); // Initial grand total calculation

            // If it's a print-ready page, trigger print dialog
            {% if print_ready %}
                window.print();
            {% endif %}
        });
    </script>
</body>
</html>
