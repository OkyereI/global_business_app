<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .form-group label {
            font-weight: 500;
            color: #555;
        }
        .form-control {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
        }
        .form-control:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
            outline: none;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #6366f1;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4a5568;
            border: 1px solid #cbd5e0;
        }
        .btn-secondary:hover {
            background-color: #cbd5e0;
            box-shadow: 0 4px 10px rgba(226, 232, 240, 0.3);
        }
        .flash-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        .flash-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .flash-danger {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .flash-warning {
            background-color: #fffbeb;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        .flash-info {
            background-color: #e0f2fe;
            color: #0369a1;
            border: 1px solid #38bdf8;
        }

        /* Specific styles for the sales receipt print area */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                /* Center content within the print area */
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                padding: 20px; /* Add some padding for print */
                box-sizing: border-box;
            }
            .receipt-container {
                width: 80mm; /* Standard receipt width */
                max-width: 300px; /* Max width for screen display */
                padding: 10px;
                border: 1px solid #ccc; /* Border for visual separation */
                background-color: white;
                box-shadow: none; /* No shadow on print */
                margin: 0 auto; /* Center the receipt itself */
                text-align: center; /* Center text within the receipt */
            }
            .receipt-header, .receipt-footer {
                text-align: center;
                margin-bottom: 10px;
            }
            .receipt-details, .receipt-items {
                text-align: left; /* Align details and items to left within receipt */
                width: 100%; /* Take full width of receipt container */
            }
            .receipt-items table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            .receipt-items th, .receipt-items td {
                border-bottom: 1px dashed #eee;
                padding: 5px 0;
                font-size: 0.85em;
            }
            .receipt-items th:nth-child(2), .receipt-items td:nth-child(2) { text-align: center; } /* Qty */
            .receipt-items th:nth-child(3), .receipt-items td:nth-child(3) { text-align: right; } /* Unit Price */
            .receipt-items th:nth-child(4), .receipt-items td:nth-child(4) { text-align: right; } /* Total */

            .receipt-grand-total {
                text-align: right;
                font-weight: bold;
                margin-top: 10px;
                padding-top: 5px;
                border-top: 1px dashed #ccc;
            }
        }

        /* Styles for screen display of the print area */
        #print-area-display {
            display: none; /* Hidden by default */
            margin-top: 2rem;
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            text-align: center; /* Center the entire display block */
        }
        #print-area-display.active {
            display: block; /* Show when active */
        }
        .receipt-container {
            width: 80mm; /* Standard receipt width */
            max-width: 300px; /* Max width for screen display */
            margin: 0 auto; /* Center the receipt itself */
            padding: 10px;
            border: 1px solid #eee;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            text-align: center; /* Center text within the receipt */
        }
        .receipt-header h2 {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .receipt-header p {
            font-size: 0.8em;
            line-height: 1.2;
        }
        .receipt-details p {
            font-size: 0.8em;
            margin-bottom: 3px;
        }
        .receipt-items table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .receipt-items th, .receipt-items td {
            padding: 5px 2px;
            border-bottom: 1px dashed #eee;
            font-size: 0.8em;
            text-align: left;
        }
        .receipt-items th:nth-child(2), .receipt-items td:nth-child(2) { text-align: center; } /* Qty */
        .receipt-items th:nth-child(3), .receipt-items td:nth-child(3) { text-align: right; } /* Unit Price */
        .receipt-items th:nth-child(4), .receipt-items td:nth-child(4) { text-align: right; } /* Total */

        .receipt-grand-total {
            font-size: 1em;
            font-weight: bold;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed #ccc;
            text-align: right;
        }
        .receipt-footer {
            font-size: 0.75em;
            margin-top: 15px;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">{{ title }}</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('add_sale') if title == 'Add Sale Record' else url_for('edit_sale', sale_id=sale.id) }}" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="customer_phone" class="block text-sm">Customer Phone (Optional)</label>
                    <input type="text" id="customer_phone" name="customer_phone" class="form-control mt-1" value="{{ sale.customer_phone if sale else '' }}">
                </div>
                <div class="form-group">
                    <label for="sales_person_name" class="block text-sm">Sales Person</label>
                    <input type="text" id="sales_person_name" name="sales_person_name" class="form-control mt-1" value="{{ sale.sales_person_name if sale else '' }}" readonly>
                </div>
            </div>

            <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-4">Items to Sell</h2>
            <div id="items-container" class="space-y-4">
                {% if sale and sale.product_id %}
                {# If editing a single sale item #}
                <div class="item-row p-4 border rounded-lg shadow-sm bg-white">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="form-group">
                            <label for="product_id" class="block text-sm">Product</label>
                            <select id="product_id" name="product_id[]" class="form-control mt-1 product-select" required>
                                <option value="">Select a Product</option>
                                {% for item in inventory_items %}
                                    <option value="{{ item.id }}" data-sale-price="{{ item.sale_price }}" data-unit-price-per-tab="{{ item.unit_price_per_tab }}" data-number-of-tabs="{{ item.number_of_tabs }}" {% if sale.product_id == item.id %}selected{% endif %}>
                                        {{ item.product_name }} (Stock: {{ item.current_stock | float | round(2) }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale_unit_type" class="block text-sm">Unit Type</label>
                            <select id="sale_unit_type" name="sale_unit_type[]" class="form-control mt-1 unit-type-select" required>
                                <option value="pack" {% if sale.sale_unit_type == 'pack' %}selected{% endif %}>Pack</option>
                                <option value="tab" {% if sale.sale_unit_type == 'tab' %}selected{% endif %}>Tab</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity_sold" class="block text-sm">Quantity</label>
                            <input type="number" id="quantity_sold" name="quantity_sold[]" class="form-control mt-1 quantity-input" step="0.01" min="0.01" value="{{ sale.quantity_sold | float | round(2) }}" required>
                        </div>
                        
                        {# Price Type and Custom Price fields, visible only for Admin role #}
                        {% if user_role == 'admin' %}
                        <div class="form-group">
                            <label for="price_type" class="block text-sm">Price Type</label>
                            <select id="price_type" name="price_type[]" class="form-control mt-1 price-type-select" required>
                                <option value="internal_percentage" {% if sale.price_type == 'internal_percentage' %}selected{% endif %}>Internal Percentage</option>
                                <option value="custom_price" {% if sale.price_type == 'custom_price' %}selected{% endif %}>Custom Price</option>
                            </select>
                        </div>
                        <div class="form-group custom-price-group {% if sale.price_type != 'custom_price' %}hidden{% endif %}">
                            <label for="custom_price" class="block text-sm">Custom Price (GH₵)</label>
                            <input type="number" id="custom_price" name="custom_price[]" class="form-control mt-1 custom-price-input" step="0.01" min="0" value="{{ sale.custom_price if sale.custom_price else '' }}">
                        </div>
                        {% else %}
                        {# Hidden inputs to ensure these values are always sent, even if not editable by sales #}
                        <input type="hidden" name="price_type[]" value="internal_percentage">
                        <input type="hidden" name="custom_price[]" value="">
                        {% endif %}

                        <div class="form-group">
                            <label for="item_total" class="block text-sm">Item Total (GH₵)</label>
                            <input type="text" id="item_total" class="form-control mt-1 item-total" value="{{ sale.total_amount | float | round(2) }}" readonly>
                        </div>
                    </div>
                </div>
                {% else %}
                {# Default empty row for adding new sales #}
                <div class="item-row p-4 border rounded-lg shadow-sm bg-white">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="form-group">
                            <label for="product_id" class="block text-sm">Product</label>
                            <select name="product_id[]" class="form-control mt-1 product-select" required>
                                <option value="">Select a Product</option>
                                {% for item in inventory_items %}
                                    <option value="{{ item.id }}" data-sale-price="{{ item.sale_price }}" data-unit-price-per-tab="{{ item.unit_price_per_tab }}" data-number-of-tabs="{{ item.number_of_tabs }}">
                                        {{ item.product_name }} (Stock: {{ item.current_stock | float | round(2) }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale_unit_type" class="block text-sm">Unit Type</label>
                            <select name="sale_unit_type[]" class="form-control mt-1 unit-type-select" required>
                                <option value="pack">Pack</option>
                                <option value="tab">Tab</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity_sold" class="block text-sm">Quantity</label>
                            <input type="number" name="quantity_sold[]" class="form-control mt-1 quantity-input" step="0.01" min="0.01" value="" required>
                        </div>

                        {# Price Type and Custom Price fields, visible only for Admin role #}
                        {% if user_role == 'admin' %}
                        <div class="form-group">
                            <label for="price_type" class="block text-sm">Price Type</label>
                            <select name="price_type[]" class="form-control mt-1 price-type-select" required>
                                <option value="internal_percentage">Internal Percentage</option>
                                <option value="custom_price">Custom Price</option>
                            </select>
                        </div>
                        <div class="form-group custom-price-group hidden">
                            <label for="custom_price" class="block text-sm">Custom Price (GH₵)</label>
                            <input type="number" name="custom_price[]" class="form-control mt-1 custom-price-input" step="0.01" min="0" value="">
                        </div>
                        {% else %}
                        <input type="hidden" name="price_type[]" value="internal_percentage">
                        <input type="hidden" name="custom_price[]" value="">
                        {% endif %}

                        <div class="form-group">
                            <label for="item_total" class="block text-sm">Item Total (GH₵)</label>
                            <input type="text" name="item_total[]" class="form-control mt-1 item-total" value="0.00" readonly>
                        </div>
                    </div>
                    {% if title == 'Add Sale Record' %}
                    <button type="button" class="remove-item-btn mt-4 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Remove</button>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {% if title == 'Add Sale Record' %}
            <button type="button" id="add-item-btn" class="btn btn-secondary mt-4">Add Another Item</button>
            {% endif %}

            <div class="form-group mt-6">
                <label for="grand_total" class="block text-xl font-bold text-gray-800">Grand Total: GH₵<span id="grand_total_display">0.00</span></label>
                <input type="hidden" id="grand_total_input" name="grand_total" value="0.00">
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <a href="{{ url_for('sales') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    {{ 'Add Sale' if title == 'Add Sale Record' else 'Update Sale' }}
                </button>
            </div>
        </form>

        {# Print Area - Hidden by default, shown for printing #}
        <div id="print-area-display" class="{% if print_ready %}active{% endif %}">
            <button id="print-receipt-btn" class="btn btn-primary mb-4">Print Receipt</button>
            <div id="print-area" class="receipt-container">
                <div class="receipt-header">
                    <h2>{{ pharmacy_info.name }}</h2>
                    <p>{{ pharmacy_info.location }}</p>
                    <p>{{ pharmacy_info.address }}</p>
                    <p>Contact: {{ pharmacy_info.contact }}</p>
                    <h3 class="font-semibold mt-2">SALES RECEIPT</h3>
                </div>
                <div class="receipt-details">
                    <p><strong>Transaction ID:</strong> {{ last_transaction_id }}</p>
                    <p><strong>Date:</strong> {{ last_transaction_date }}</p>
                    <p><strong>Sales Person:</strong> {{ last_transaction_sales_person }}</p>
                    <p><strong>Customer Phone:</strong> {{ last_transaction_customer_phone if last_transaction_customer_phone else 'N/A' }}</p>
                </div>
                <div class="receipt-items">
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in last_transaction_details | default([]) %} {# Added default([]) filter here #}
                            <tr>
                                <td>{{ item.product_name }}</td>
                                <td>{{ item.quantity_sold | float | round(2) }} {{ 'tab(s)' if item.sale_unit_type == 'tab' else 'pack(s)' }}</td>
                                <td>GH₵{{ item.price_at_time_per_unit_sold | float | round(2) }}</td>
                                <td>GH₵{{ item.total_amount | float | round(2) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="receipt-grand-total">
                    <p>GRAND TOTAL: GH₵{{ last_transaction_grand_total | float | round(2) }}</p>
                </div>
                <div class="receipt-footer">
                    <p>Thank you for your business!</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const itemsContainer = document.getElementById('items-container');
            const addItemBtn = document.getElementById('add-item-btn');
            const grandTotalDisplay = document.getElementById('grand_total_display');
            const grandTotalInput = document.getElementById('grand_total_input');
            const printReceiptBtn = document.getElementById('print-receipt-btn');
            const printAreaDisplay = document.getElementById('print-area-display');

            // Function to calculate and update total for an item row
            function updateItemTotal(itemRow) {
                const productSelect = itemRow.querySelector('.product-select');
                const unitTypeSelect = itemRow.querySelector('.unit-type-select');
                const quantityInput = itemRow.querySelector('.quantity-input');
                const itemTotalInput = itemRow.querySelector('.item-total');
                const priceTypeSelect = itemRow.querySelector('.price-type-select');
                const customPriceInput = itemRow.querySelector('.custom-price-input');
                const customPriceGroup = itemRow.querySelector('.custom-price-group');

                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const salePrice = parseFloat(selectedOption.dataset.salePrice);
                const unitPricePerTab = parseFloat(selectedOption.dataset.unitPricePerTab);
                const numberOfTabs = parseInt(selectedOption.dataset.numberOfTabs);
                const quantity = parseFloat(quantityInput.value);

                let itemTotal = 0;
                let pricePerUnit = 0;

                // Toggle custom price input visibility
                if (priceTypeSelect && customPriceGroup) { // Check if elements exist (i.e., user is admin)
                    if (priceTypeSelect.value === 'custom_price') {
                        customPriceGroup.classList.remove('hidden');
                        customPriceInput.setAttribute('required', 'true');
                    } else {
                        customPriceGroup.classList.add('hidden');
                        customPriceInput.removeAttribute('required');
                        customPriceInput.value = ''; // Clear custom price if not used
                    }
                }

                if (!isNaN(quantity) && quantity > 0) {
                    if (priceTypeSelect && priceTypeSelect.value === 'custom_price' && customPriceInput && customPriceInput.value !== '') {
                        pricePerUnit = parseFloat(customPriceInput.value);
                    } else {
                        // Use internal percentage price
                        if (unitTypeSelect.value === 'tab') {
                            pricePerUnit = unitPricePerTab;
                        } else { // pack
                            pricePerUnit = salePrice;
                        }
                    }

                    if (unitTypeSelect.value === 'tab') {
                        itemTotal = quantity * pricePerUnit;
                    } else { // pack
                        itemTotal = quantity * pricePerUnit;
                    }
                }
                itemTotalInput.value = itemTotal.toFixed(2);
                updateGrandTotal();
            }

            // Function to update the grand total
            function updateGrandTotal() {
                let grandTotal = 0;
                document.querySelectorAll('.item-row').forEach(itemRow => {
                    const itemTotal = parseFloat(itemRow.querySelector('.item-total').value);
                    if (!isNaN(itemTotal)) {
                        grandTotal += itemTotal;
                    }
                });
                grandTotalDisplay.textContent = grandTotal.toFixed(2);
                grandTotalInput.value = grandTotal.toFixed(2);
            }

            // Event listener for adding new item rows (only for Add Sale page)
            if (addItemBtn) {
                addItemBtn.addEventListener('click', function() {
                    const newItemRow = document.createElement('div');
                    newItemRow.classList.add('item-row', 'p-4', 'border', 'rounded-lg', 'shadow-sm', 'bg-white');
                    newItemRow.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="form-group">
                                <label for="product_id" class="block text-sm">Product</label>
                                <select name="product_id[]" class="form-control mt-1 product-select" required>
                                    <option value="">Select a Product</option>
                                    {% for item in inventory_items %}
                                        <option value="{{ item.id }}" data-sale-price="{{ item.sale_price }}" data-unit-price-per-tab="{{ item.unit_price_per_tab }}" data-number-of-tabs="{{ item.number_of_tabs }}">
                                            {{ item.product_name }} (Stock: {{ item.current_stock | float | round(2) }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sale_unit_type" class="block text-sm">Unit Type</label>
                                <select name="sale_unit_type[]" class="form-control mt-1 unit-type-select" required>
                                    <option value="pack">Pack</option>
                                    <option value="tab">Tab</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="quantity_sold" class="block text-sm">Quantity</label>
                                <input type="number" name="quantity_sold[]" class="form-control mt-1 quantity-input" step="0.01" min="0.01" value="" required>
                            </div>
                            
                            {# Price Type and Custom Price fields, visible only for Admin role #}
                            {% if user_role == 'admin' %}
                            <div class="form-group">
                                <label for="price_type" class="block text-sm">Price Type</label>
                                <select name="price_type[]" class="form-control mt-1 price-type-select" required>
                                    <option value="internal_percentage">Internal Percentage</option>
                                    <option value="custom_price">Custom Price</option>
                                </select>
                            </div>
                            <div class="form-group custom-price-group hidden">
                                <label for="custom_price" class="block text-sm">Custom Price (GH₵)</label>
                                <input type="number" name="custom_price[]" class="form-control mt-1 custom-price-input" step="0.01" min="0" value="">
                            </div>
                            {% else %}
                            <input type="hidden" name="price_type[]" value="internal_percentage">
                            <input type="hidden" name="custom_price[]" value="">
                            {% endif %}

                            <div class="form-group">
                                <label for="item_total" class="block text-sm">Item Total (GH₵)</label>
                                <input type="text" name="item_total[]" class="form-control mt-1 item-total" value="0.00" readonly>
                            </div>
                        </div>
                        <button type="button" class="remove-item-btn mt-4 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Remove</button>
                    `;
                    itemsContainer.appendChild(newItemRow);
                    attachEventListenersToItemRow(newItemRow);
                    updateGrandTotal();
                });
            }

            // Function to attach event listeners to a single item row
            function attachEventListenersToItemRow(itemRow) {
                const productSelect = itemRow.querySelector('.product-select');
                const unitTypeSelect = itemRow.querySelector('.unit-type-select');
                const quantityInput = itemRow.querySelector('.quantity-input');
                const removeItemBtn = itemRow.querySelector('.remove-item-btn');
                const priceTypeSelect = itemRow.querySelector('.price-type-select');
                const customPriceInput = itemRow.querySelector('.custom-price-input');

                productSelect.addEventListener('change', () => updateItemTotal(itemRow));
                unitTypeSelect.addEventListener('change', () => updateItemTotal(itemRow));
                quantityInput.addEventListener('input', () => updateItemTotal(itemRow));
                if (priceTypeSelect) { // Only if admin role
                    priceTypeSelect.addEventListener('change', () => updateItemTotal(itemRow));
                }
                if (customPriceInput) { // Only if admin role
                    customPriceInput.addEventListener('input', () => updateItemTotal(itemRow));
                }

                if (removeItemBtn) {
                    removeItemBtn.addEventListener('click', function() {
                        itemRow.remove();
                        updateGrandTotal();
                    });
                }
            }

            // Attach event listeners to all existing item rows on page load
            document.querySelectorAll('.item-row').forEach(attachEventListenersToItemRow);

            // Initial calculation on page load
            updateGrandTotal();

            // Print functionality
            if (printReceiptBtn) {
                printReceiptBtn.addEventListener('click', function() {
                    window.print();
                });
            }

            // Show/hide print area based on printReady variable
            const printReady = {{ print_ready | tojson }}; // This is now guaranteed to be boolean
            if (printReady) {
                printAreaDisplay.classList.add('active');
            } else {
                printAreaDisplay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
